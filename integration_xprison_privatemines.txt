Bonjour,

Après analyse de votre problème d'intégration entre X-Prison et PrivateMines, voici mon évaluation :

## Analyse du problème

Le flag WorldGuard semble correctement configuré, mais le système d'enchantements de X-Prison n'est pas déclenché. Cela peut être dû à plusieurs facteurs:

1. **Ordre d'exécution des listeners** - Si votre plugin traite l'événement avant X-Prison, certaines modifications pourraient interférer
2. **Problème de priorité des régions** - Peut-être que la région fullmine (priorité -1) interfère avec la région mine (priorité 1)
3. **Vérification de la région** - X-Prison utilise `RegionUtils.getRegionWithHighestPriorityAndFlag()` qui pourrait ne pas fonctionner comme prévu

## Évaluation de votre solution

Votre approche d'appeler directement le gestionnaire d'enchantements est valide mais présente quelques risques:

1. **Double traitement** - L'événement pourrait être traité deux fois par X-Prison
2. **Dépendance explicite** - Crée une dépendance forte entre les plugins
3. **Maintenance** - Si X-Prison change son API, votre code devra être mis à jour

## Solutions recommandées (par ordre de préférence)

### 1. Utiliser l'API de X-Prison si disponible

```java
@EventHandler(priority = EventPriority.NORMAL)
public void onBlockBreak(BlockBreakEvent event) {
    if (hasMineAt(event.getBlock().getLocation())) {
        // Vérifier si le flag est bien appliqué sur la région
        if (!isEnchantFlagAllowed(event.getBlock().getLocation())) {
            // Déboguer le problème
            logRegionInfo(event.getBlock().getLocation());
        }
    }
}

private boolean isEnchantFlagAllowed(Location location) {
    RegionContainer container = WorldGuard.getInstance().getPlatform().getRegionContainer();
    RegionQuery query = container.createQuery();
    return query.testState(BukkitAdapter.adapt(location), null, 
            (StateFlag) WorldGuard.getInstance().getFlagRegistry().get("upc-enchants"));
}

private void logRegionInfo(Location location) {
    // Log les régions à cette position et leurs flags
}
```

### 2. Modifier la priorité d'événement

```java
@EventHandler(priority = EventPriority.LOW) // Utiliser LOW pour s'exécuter avant NORMAL
public void onBlockBreak(BlockBreakEvent event) {
    // Votre logique existante
    // Ne pas modifier l'événement si possible
}
```

### 3. Adapter votre solution actuelle

Si vous devez appeler directement X-Prison, ajoutez ces améliorations:

```java
@EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
public void onBlockBreak(BlockBreakEvent event) {
    // Éviter de traiter les événements déjà gérés par X-Prison
    if (event.hasMetadata("xprison_processed")) return;
    
    if (hasMineAt(event.getBlock().getLocation())) {
        Plugin xPrisonPlugin = Bukkit.getPluginManager().getPlugin("X-Prison");
        if (xPrisonPlugin != null && xPrisonPlugin.isEnabled()) {
            try {
                // Marquer l'événement comme traité
                event.setMetadata("privatemines_processed", 
                      new FixedMetadataValue(this.plugin, true));
                
                // Utiliser la réflexion pour rendre le code plus robuste
                Object xPrison = xPrisonPlugin;
                Method getEnchantsMethod = xPrison.getClass().getMethod("getEnchants");
                Object enchants = getEnchantsMethod.invoke(xPrison);
                
                if (enchants != null) {
                    Method isEnabledMethod = enchants.getClass().getMethod("isEnabled");
                    boolean enabled = (boolean) isEnabledMethod.invoke(enchants);
                    
                    if (enabled) {
                        Method getManagerMethod = enchants.getClass().getMethod("getEnchantsManager");
                        Object manager = getManagerMethod.invoke(enchants);
                        
                        Method handleBlockBreakMethod = manager.getClass().getMethod(
                            "handleBlockBreak", BlockBreakEvent.class, ItemStack.class);
                        handleBlockBreakMethod.invoke(manager, event, event.getPlayer().getItemInHand());
                    }
                }
            } catch (Exception e) {
                getLogger().warning("Erreur lors de l'appel à X-Prison: " + e.getMessage());
            }
        }
    }
}
```

## Recommandations supplémentaires

1. **Ajouter du débogage** pour vérifier que les flags sont bien appliqués:
   ```java
   RegionManager rm = WorldGuard.getInstance().getPlatform().getRegionContainer()
       .get(BukkitAdapter.adapt(world));
   ProtectedRegion region = rm.getRegion("mine-" + uuid);
   if (region != null) {
       StateFlag flag = (StateFlag) WorldGuard.getInstance().getFlagRegistry()
           .get("upc-enchants");
       getLogger().info("Flag upc-enchants pour " + region.getId() + ": " + 
           region.getFlag(flag));
   }
   ```

2. **Soft dependency** - Ajoutez X-Prison comme soft-dependency dans votre plugin.yml

3. **Test isolé** - Testez les régions WorldGuard seules, sans PrivateMines, pour confirmer que le flag fonctionne correctement

Avec ces ajustements, l'intégration devrait fonctionner correctement sans effets secondaires majeurs. 